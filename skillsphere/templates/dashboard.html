{% extends "base.html" %}
{% load static %}
{% block content %}
{% load humanize %}


<section class="main-content py-12">

  <div class="max-w-6xl mx-auto px-6">
    <h1 class="text-3xl font-extrabold text-white mb-6">Welcome back, {{ user.first_name|default:user.username }} ðŸ‘‹</h1>

    <!-- top cards -->
    <div class="cards mb-8">
      <div class="card">
        <h4 class="text-gray-300">Skills Added</h4>
        <div class="text-3xl font-bold text-yellow-400">{{ skills_count }}</div>
      </div>
      <div class="card">
        <h4 class="text-gray-300">Internships</h4>
        <div class="text-3xl font-bold text-yellow-400">{{ internships_count }}</div>
      </div>
      <div class="card">
        <h4 class="text-gray-300">Applications</h4>
        <div class="text-3xl font-bold text-yellow-400">{{ applications_count }}</div>
      </div>
      <div class="card">
        <h4 class="text-gray-300">Avg Progress</h4>
        <div class="text-3xl font-bold text-yellow-400">{{ avg_progress }}%</div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card mb-10">
      <h2 class="text-xl text-gray-200 font-semibold mb-4">Skill Progress Overview</h2>
      <canvas id="dashboardChart" height="120"></canvas>
      <p id="no-data-msg" class="text-gray-400 mt-4" style="display:none;">No skills yet â€” add a skill to see progress.</p>
    </div>

    <!-- Skills list -->
    <h2 class="text-2xl text-white font-semibold mt-8 mb-4">Your Skills</h2>
    <div class="card">
      {% if user_skills %}
        {% for us in user_skills %}
          <div class="mb-4 pb-3 border-b border-gray-700 flex items-center justify-between">
            <div>
              <a href="{% url 'skill_practice' us.skill.slug %}" class="text-yellow-400 font-semibold text-lg hover:underline">{{ us.skill.name }}</a>
              <div class="text-sm text-gray-400">Updated {{ us.updated_at|naturaltime }}</div>
            </div>

            <div class="w-1/3 text-right">
              <div class="progress-bar mb-1">
                <span style="width: {{ us.progress }}%"></span>
              </div>
              <div class="text-sm text-gray-300">{{ us.progress }}%</div>

              <div class="mt-2 inline-flex gap-2">
                <!-- <a href="{% url 'edit_skill' us.id %}" class="px-3 py-1 rounded bg-gray-800 text-gray-200 text-sm">Edit</a> -->
                <form method="post" action="{% url 'delete_skill' us.id %}" style="display:inline;">
                  {% csrf_token %}
                  <button class="px-3 py-1 rounded bg-red-600 text-white text-sm" type="submit">Delete</button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-gray-400">You haven't added any skills yet. Visit <a href="{% url 'skills' %}" class="text-yellow-400">Skills</a> to add your first skill.</p>
      {% endif %}
    </div>

    <!-- Recommended internships -->
    <h2 class="text-2xl text-white font-semibold mt-10 mb-4">Recommended Micro-Internships</h2>
    <div class="cards">
      {% for internship in internships_count|yesno:"1,1" %}
        <!-- placeholder - actual internships page is separate -->
      {% endfor %}
      <!-- show example card to guide user -->
      <div class="card">
        <h4 class="text-yellow-400">Frontend Developer</h4>
        <p class="text-gray-400">Practice building UIs to earn points & badges.</p>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
async function loadChart() {
  const resp = await fetch("{% url 'skill_data' %}");
  if (!resp.ok) return;
  const json = await resp.json();
  const labels = json.labels;
  const values = json.values;

  if (!labels.length) {
    document.getElementById('no-data-msg').style.display = 'block';
  }

  const ctx = document.getElementById('dashboardChart').getContext('2d');
  if (window.__dashboardChart) window.__dashboardChart.destroy();
  window.__dashboardChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Progress (%)',
        data: values,
        backgroundColor: values.map(v => v === 0 ? 'rgba(148,163,184,0.35)' : '#8b5cf6'),
        borderColor: '#8b5cf6',
        borderWidth: 1,
        borderRadius: 6
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true, max: 100, ticks: { color: '#9ca3af' }, grid: { color: '#374151' } },
        x: { ticks: { color: '#9ca3af' }, grid: { display: false } }
      },
      plugins: { legend: { display: false } }
    }
  });
}

loadChart();
</script>

{% endblock %}
